{% extends "base.html" %}

{% block conteudo %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">ðŸ“‹ Dados da Planilha</h2>

    <!-- BotÃ£o Adicionar -->
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAdd">
        <i class="bi bi-plus-circle"></i> Adicionar
    </button>
</div>

<!-- Tabela -->
<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <thead class="table-dark" id="header"></thead>
        <tbody id="corpo"></tbody>
    </table>
</div>

<!-- =======================
       MODAL ADICIONAR
=========================== -->
<div class="modal fade" id="modalAdd" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Adicionar LanÃ§amento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label">MÃªs</label>
                    <input type="text" id="addMes" class="form-control" placeholder="Ex: JAN.">
                </div>

                <div class="mb-2">
                    <label class="form-label">Data</label>
                    <input type="date" id="addData" class="form-control">
                </div>

                <div class="mb-2">
                    <label class="form-label">Categoria</label>
                    <input type="text" id="addCategoria" class="form-control">
                </div>

                <div class="mb-2">
                    <label class="form-label">Conta</label>
                    <input type="text" id="addConta" class="form-control">
                </div>

                <div class="mb-2">
                    <label class="form-label">DescriÃ§Ã£o</label>
                    <input type="text" id="addDescricao" class="form-control">
                </div>

                <div class="mb-2">
                    <label class="form-label">Valor</label>
                    <input type="number" step="0.01" id="addValor" class="form-control" placeholder="0.00">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" onclick="salvarLancamento()">Salvar</button>
            </div>

        </div>
    </div>
</div>

<!-- =======================
       JAVASCRIPT
=========================== -->
<script>
const DESIRED_ORDER = ["MES","DATA","CATEGORIA","CONTA","DESCRICAO","VALOR"];

function getField(row, col) {
    if (col in row) return row[col];
    return row[col.toLowerCase()] ?? row[col.toUpperCase()] ?? "";
}

async function loadData() {
    const req = await fetch("/rows");
    const rows = await req.json();

    const header = document.getElementById("header");
    const corpo = document.getElementById("corpo");

    header.innerHTML = "";
    corpo.innerHTML = "";

    let headerHTML = "<tr>";
    DESIRED_ORDER.forEach(c => headerHTML += `<th>${c}</th>`);
    headerHTML += `<th>AÃ‡Ã•ES</th>`;
    headerHTML += "</tr>";
    header.innerHTML = headerHTML;

    rows.forEach((row, index) => {
        let tr = "<tr>";
        DESIRED_ORDER.forEach(col => {
            tr += `<td>${getField(row, col)}</td>`;
        });

        tr += `<td class="text-center">
                <button class="btn btn-sm btn-warning me-1" onclick="editRow(${index + 5})">
                    <i class="bi bi-pencil-fill"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteRow(${index + 5})">
                    <i class="bi bi-trash3-fill"></i>
                </button>
            </td>`;

        tr += "</tr>";
        corpo.innerHTML += tr;
    });
}

async function deleteRow(sheetRow) {
    if (!confirm("Excluir a linha da planilha " + sheetRow + "?")) return;

    const res = await fetch("/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ index: sheetRow })
    });

    if (!res.ok) {
        alert("Erro ao excluir.");
        return;
    }

    loadData();
}

async function salvarLancamento() {
    const mes = document.getElementById("addMes").value;
    const data = document.getElementById("addData").value;
    const categoria = document.getElementById("addCategoria").value;
    const conta = document.getElementById("addConta").value;
    const descricao = document.getElementById("addDescricao").value;
    const valor = document.getElementById("addValor").value;

    if (!mes || !data || !categoria || !conta || !descricao || !valor) {
        alert("Preencha todos os campos!");
        return;
    }

    const row = [mes, data, categoria, conta, descricao, valor];

    const res = await fetch("/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ row }),
    });

    if (!res.ok) {
        alert("Erro ao salvar!");
        return;
    }

    document.querySelector("#modalAdd .btn-close").click();

    loadData();
}
document.addEventListener("DOMContentLoaded", loadData);
</script>

{% endblock %}
